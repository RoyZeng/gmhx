<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.gome.gmhx.dao.workflow.JbpmTaskTrajectoryDao" >
  <resultMap id="BaseResultMap" type="com.gome.gmhx.jbpm.JbpmTaskTrajectory" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="create_date" property="createDate" jdbcType="TIMESTAMP" />
    <id column="pk_id" property="pkId" jdbcType="VARCHAR" />
    <id column="process_definition_key" property="processDefinitionKey" jdbcType="VARCHAR" />
    <result column="applicant" property="applicant" jdbcType="VARCHAR" />
    <result column="apply_time" property="applyTime" jdbcType="TIMESTAMP" />
    <result column="current_activity" property="currentActivity" jdbcType="VARCHAR" />
    <result column="participant" property="participant" jdbcType="VARCHAR" />
    <result column="work_entity_id" property="workEntityId" jdbcType="VARCHAR" />
    <result column="process_instance_id" property="processInstanceId" jdbcType="VARCHAR" />
    <result column="out_going_name" property="outGoingName" jdbcType="VARCHAR" />
    <result column="approve_comment" property="approveComment" jdbcType="VARCHAR" />
    <result column="next_activity_name" property="nextActivityName" jdbcType="VARCHAR" />
    <result column="next_participants" property="nextParticipants" jdbcType="VARCHAR" />
    <result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
  </resultMap>
  
  <resultMap id="JBPMOrderVOResultMap" type="com.gome.gmhx.entity.vo.HxJBPMOrderVO" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="list_number" property="listNumber" jdbcType="VARCHAR" />
    <id column="process_instance_id" property="processInstanceId" jdbcType="VARCHAR" />
    <result column="proposer" property="proposer" jdbcType="VARCHAR" />
    <result column="apply_date" property="applyDate" jdbcType="TIMESTAMP" />
    <result column="update_person" property="updatePerson" jdbcType="VARCHAR" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="status" property="status" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    create_date, pk_id, process_definition_key, applicant, apply_time, current_activity, 
    participant, work_entity_id, process_instance_id, out_going_name, approve_comment, 
    next_activity_name, next_participants,start_time,end_time
  </sql>
  
  <insert id="insert" parameterType="com.gome.gmhx.jbpm.JbpmTaskTrajectory" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into JBPM4_TASK_TRAJECTTORY (create_date, pk_id, process_definition_key, 
      applicant, apply_time, current_activity, 
      participant, work_entity_id, process_instance_id, 
      out_going_name, approve_comment, next_activity_name, 
      next_participants,start_time,end_time)
    values (#{createDate,jdbcType=TIMESTAMP}, #{pkId,jdbcType=VARCHAR}, #{processDefinitionKey,jdbcType=VARCHAR}, 
      #{applicant,jdbcType=VARCHAR}, #{applyTime,jdbcType=TIMESTAMP}, #{currentActivity,jdbcType=VARCHAR}, 
      #{participant,jdbcType=VARCHAR}, #{workEntityId,jdbcType=VARCHAR}, #{processInstanceId,jdbcType=VARCHAR}, 
      #{outGoingName,jdbcType=VARCHAR}, #{approveComment,jdbcType=VARCHAR}, #{nextActivityName,jdbcType=VARCHAR}, 
      #{nextParticipants,jdbcType=VARCHAR},#{startTime,jdbcType=TIMESTAMP},#{endTime,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="com.gome.gmhx.jbpm.JbpmTaskTrajectory" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into JBPM4_TASK_TRAJECTTORY
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="createDate != null" >
        create_date,
      </if>
      <if test="pkId != null" >
        pk_id,
      </if>
      <if test="processDefinitionKey != null" >
        process_definition_key,
      </if>
      <if test="applicant != null" >
        applicant,
      </if>
      <if test="applyTime != null" >
        apply_time,
      </if>
      <if test="currentActivity != null" >
        current_activity,
      </if>
      <if test="participant != null" >
        participant,
      </if>
      <if test="workEntityId != null" >
        work_entity_id,
      </if>
      <if test="processInstanceId != null" >
        process_instance_id,
      </if>
      <if test="outGoingName != null" >
        out_going_name,
      </if>
      <if test="approveComment != null" >
        approve_comment,
      </if>
      <if test="nextActivityName != null" >
        next_activity_name,
      </if>
      <if test="nextParticipants != null" >
        next_participants,
      </if>
       <if test="nextParticipants != null" >
        start_time,
      </if>
     <if test="nextParticipants != null" >
        end_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="createDate != null" >
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="pkId != null" >
        #{pkId,jdbcType=VARCHAR},
      </if>
      <if test="processDefinitionKey != null" >
        #{processDefinitionKey,jdbcType=VARCHAR},
      </if>
      <if test="applicant != null" >
        #{applicant,jdbcType=VARCHAR},
      </if>
      <if test="applyTime != null" >
        #{applyTime,jdbcType=TIMESTAMP},
      </if>
      <if test="currentActivity != null" >
        #{currentActivity,jdbcType=VARCHAR},
      </if>
      <if test="participant != null" >
        #{participant,jdbcType=VARCHAR},
      </if>
      <if test="workEntityId != null" >
        #{workEntityId,jdbcType=VARCHAR},
      </if>
      <if test="processInstanceId != null" >
        #{processInstanceId,jdbcType=VARCHAR},
      </if>
      <if test="outGoingName != null" >
        #{outGoingName,jdbcType=VARCHAR},
      </if>
      <if test="approveComment != null" >
        #{approveComment,jdbcType=VARCHAR},
      </if>
      <if test="nextActivityName != null" >
        #{nextActivityName,jdbcType=VARCHAR},
      </if>
      <if test="nextParticipants != null" >
        #{nextParticipants,jdbcType=VARCHAR},
      </if>
      <if test="applyTime != null" >
        #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="applyTime != null" >
        #{endTime,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.gome.gmhx.jbpm.JbpmTaskTrajectory" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update JBPM4_TASK_TRAJECTTORY
    <set >
      <if test="applicant != null" >
        applicant = #{applicant,jdbcType=VARCHAR},
      </if>
      <if test="applyTime != null" >
        apply_time = #{applyTime,jdbcType=TIMESTAMP},
      </if>
      <if test="currentActivity != null" >
        current_activity = #{currentActivity,jdbcType=VARCHAR},
      </if>
      <if test="participant != null" >
        participant = #{participant,jdbcType=VARCHAR},
      </if>
      <if test="workEntityId != null" >
        work_entity_id = #{workEntityId,jdbcType=VARCHAR},
      </if>
      <if test="processInstanceId != null" >
        process_instance_id = #{processInstanceId,jdbcType=VARCHAR},
      </if>
      <if test="outGoingName != null" >
        out_going_name = #{outGoingName,jdbcType=VARCHAR},
      </if>
      <if test="approveComment != null" >
        approve_comment = #{approveComment,jdbcType=VARCHAR},
      </if>
      <if test="nextActivityName != null" >
        next_activity_name = #{nextActivityName,jdbcType=VARCHAR},
      </if>
      <if test="nextParticipants != null" >
        next_participants = #{nextParticipants,jdbcType=VARCHAR},
      </if>
      <if test="startTime != null" >
        start_time = #{nextParticipants,jdbcType=VARCHAR},
      </if>
   		<if test="endTime != null" >
        end_time = #{nextParticipants,jdbcType=VARCHAR},
      </if>
    </set>
    where create_date = #{createDate,jdbcType=TIMESTAMP}
      and pk_id = #{pkId,jdbcType=VARCHAR}
      and process_definition_key = #{processDefinitionKey,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.gome.gmhx.jbpm.JbpmTaskTrajectory" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update JBPM4_TASK_TRAJECTTORY
    set applicant = #{applicant,jdbcType=VARCHAR},
      apply_time = #{applyTime,jdbcType=TIMESTAMP},
      current_activity = #{currentActivity,jdbcType=VARCHAR},
      participant = #{participant,jdbcType=VARCHAR},
      work_entity_id = #{workEntityId,jdbcType=VARCHAR},
      process_instance_id = #{processInstanceId,jdbcType=VARCHAR},
      out_going_name = #{outGoingName,jdbcType=VARCHAR},
      approve_comment = #{approveComment,jdbcType=VARCHAR},
      next_activity_name = #{nextActivityName,jdbcType=VARCHAR},
      next_participants = #{nextParticipants,jdbcType=VARCHAR},
      start_time = #{startTime,jdbcType=VARCHAR},
      end_time = #{endTime,jdbcType=VARCHAR} 
    where create_date = #{createDate,jdbcType=TIMESTAMP}
      and pk_id = #{pkId,jdbcType=VARCHAR}
      and process_definition_key = #{processDefinitionKey,jdbcType=VARCHAR}
  </update>
  
  <select id="getWorkPageList" parameterType="com.gome.common.page.Page" resultMap="JBPMOrderVOResultMap">
   select work_entity_id as list_number,applicant as proposer,apply_date,process_instance_id,status from v_work_entity where 1=1
   and work_entity_id in  ${param.ids}
   <if test="param.listNumber != null and param.listNumber !='' ">
		   and work_entity_id like CONCAT('%',#{param.listNumber},'%')
   </if>
   <if test="param.proposer != null and param.proposer !='' ">
		   and applicant like CONCAT('%',#{param.proposer},'%')
   </if>
   <if test="param.ksrq != null and param.ksrq != ''">
			<![CDATA[ and DATE_FORMAT(apply_date, '%Y-%m-%d') >= #{param.ksrq}]]>
   </if>
   <if test="param.jsrq != null and param.jsrq != ''">
			<![CDATA[ and DATE_FORMAT(apply_date, '%Y-%m-%d') <= #{param.jsrq}]]>
  </if>
   <if test="param.processInstanceId != null and param.processInstanceId !='' ">
		   and process_instance_id like CONCAT(#{param.processInstanceId},'%')
   </if>
   <if test="param.status != null and param.status !='' ">
		   and status =#{param.status,jdbcType=VARCHAR}
   </if>
   order by apply_date desc
  </select>
  
  <select id="getTaskTrajeCttoryPageList" parameterType="com.gome.common.page.Page" resultMap="BaseResultMap">
  select * from JBPM4_TASK_TRAJECTTORY where work_entity_id=#{param.workEntityId,jdbcType=VARCHAR} order by create_date
  </select>
  
  <select id="processInstanceIdToVal" parameterType="string" resultType="string">
  select cs.code_value from hx_code c,hx_code_setting cs where c.code_id=cs.code_id and c.code_name='流程模型' and cs.code_key=#{processInstanceId}
  </select>
  
  <select id="getWorkMonitoringPageList" parameterType="com.gome.common.page.Page" resultMap="JBPMOrderVOResultMap">
  SELECT t.work_entity_id as list_number,t.applicant as proposer,t.apply_time as apply_date,t.process_instance_id,t.next_activity_name as status FROM JBPM4_TASK_TRAJECTTORY t,
	(SELECT process_instance_id,MAX(create_date) as last_record FROM 	JBPM4_TASK_TRAJECTTORY GROUP BY process_instance_id ) t1
    where t.process_instance_id=t1.process_instance_id and t.create_date=t1.last_record 
   <if test="param.flag != null and param.flag !='' and param.flag ==1 ">
		   and t.next_activity_name != 'S0' and  t.process_instance_id in (select t2.process_instance_id from JBPM4_TASK_TRAJECTTORY t2 where t2.participant=#{param.participant})
   </if>
   <if test="param.flag != null and param.flag !='' and param.flag ==2 ">
		   and t.next_activity_name = 'S0' and  t.process_instance_id in (select t2.process_instance_id from JBPM4_TASK_TRAJECTTORY t2 where t2.participant=#{param.participant})
   </if>
   <if test="param.flag != null and param.flag !='' and param.flag ==3 ">
		   and t.next_activity_name != 'S0'
   </if>
   <if test="param.listNumber != null and param.listNumber !='' ">
		   and t.work_entity_id like CONCAT('%',#{param.listNumber},'%')
   </if>
   <if test="param.proposer != null and param.proposer !='' ">
		   and t.applicant like CONCAT('%',#{param.proposer},'%')
   </if>
   <if test="param.ksrq != null and param.ksrq != ''">
			<![CDATA[ and DATE_FORMAT(t.apply_time, '%Y-%m-%d') >= #{param.ksrq}]]>
   </if>
   <if test="param.jsrq != null and param.jsrq != ''">
			<![CDATA[ and DATE_FORMAT(t.apply_time, '%Y-%m-%d') <= #{param.jsrq}]]>
  </if>
   <if test="param.processInstanceId != null and param.processInstanceId !='' ">
		   and t.process_instance_id like CONCAT(#{param.processInstanceId},'%')
   </if>
   <if test="param.status != null and param.status !='' ">
		   and t.current_activity =#{param.status,jdbcType=VARCHAR}
   </if>
   ORDER BY create_date DESC
  </select>
  
</mapper>